name: Build Kivy Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install system build dependencies (autotools, libtool, JDK, etc.)
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          autoconf \
          automake \
          libtool \
          libtool-bin \
          pkg-config \
          build-essential \
          python3-dev \
          libffi-dev \
          libssl-dev \
          zlib1g-dev \
          liblzma-dev \
          openjdk-11-jdk \
          unzip \
          zip \
          libncurses5 \
          libncurses5-dev \
          libgtk-3-dev \
          git
        # Keep disk tidy
        sudo rm -rf /var/lib/apt/lists/*

    - name: Show important tool versions (debug)
      run: |
        python --version
        pip --version
        gcc --version
        autoconf --version || true
        automake --version || true
        libtool --version || true
        java -version || true

    - name: Upgrade pip and install Buildozer & python-for-android
      run: |
        python -m pip install --upgrade pip setuptools wheel
        # pin versions if you use known-good versions; unpinned will fetch latest
        pip install --upgrade buildozer cython python-for-android

    - name: (Optional) Accept Android SDK licenses early (if needed)
      # This is optional; buildozer will normally download and install SDK/NDK by itself.
      run: |
        mkdir -p "$HOME/.android"
        # create a placeholder licenses file so some steps don't get interactive prompts
        echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > "$HOME/.android/repositories.cfg" || true

    - name: Build APK with Buildozer
      env:
        # you can override these to match your buildozer.spec if desired
        ANDROIDAPI: "34"
        ANDROIDMINAPI: "23"
        # ensure python-for-android caches / storage live in the workspace
        BUILD_DIR: "${{ github.workspace }}/.buildozer"
      run: |
        # show current working dir
        pwd
        ls -la
        # If you want verbose logs for debugging add --verbose (this can be very chatty)
        buildozer --verbose android debug
